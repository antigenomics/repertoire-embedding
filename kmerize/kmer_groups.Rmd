---
title: "kmers"
output: html_document
date: '2022-09-21'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(reshape2)
library(data.table)
library(parallel)
```

### K-mer clustering

We will now cluster all k-mers $\kappa \in \mathcal K$. Load amino acid 
properties so we can do $\kappa \rightarrow \vec x$ - we'll use them for 
clustering. Otherwise need smth like BLOSUM pairwise scores 
$\kappa_1,\kappa_2 \rightarrow d_{12}$. And storing (dense) $d_{12}$ matrix is 
a lot of space even for $k=3$.

```{r}
props <- read_tsv("aa_property_table.txt")
aas <- props$amino_acid

props.1 <- props %>%
  mutate(aa = amino_acid) %>%
  select(-amino_acid) %>%
  melt()
```

Dirty script to make the set of all k-mers

```{r}
all.kmers <- tibble(aa1 = aas) %>% 
  merge(tibble(aa2 = aas)) %>% 
  merge(tibble(aa3 = aas)) %>%
  mutate(kmer = paste0(aa1, aa2, aa3)) %>%
  melt(id = "kmer", value.name = "aa") %>%
  mutate(pos = substr(variable, 3, 3)) %>%
  select(-variable)
```

Append AA props

```{r}
all.kmer.pros <- all.kmers %>%
  merge(props.1)

all.kmer.pros.1 <- all.kmer.pros %>%
  dcast(kmer ~ variable, value.var = "value", fun.aggregate = sum)
```

Transform to matrix $\kappa \times f$ with $f=10$ features

```{r}
all.kmer.pros.2 <- all.kmer.pros.1 %>%
  select(-kmer)
all.kmer.pros.2 <- as.matrix(all.kmer.pros.2)
rownames(all.kmer.pros.2) <- all.kmer.pros.1$kmer

clust <- hclust(dist(all.kmer.pros.2))
```

Draw dendrogram and cluster into $10$ clusters

```{r}
plot(clust) # TODO: more fancy dendro, perhaps with circle
clusters <- cutree(clust, 10)
```

### k-merization procedure

Optimized routines for k-merization of CDR3s

```{r}
K = 3
CORES = 8

cdr3_to_kmers <- function(cdr3, k = K) {
  pos <- 1:(nchar(cdr3) - k + 1)
  kmer <- sapply(pos, function(x) substr(cdr3, x, x + k - 1))
  data.table(cdr3, pos, kmer)
}
cdr3_to_kmers("CASSLAPGATNEKLFF")

cdr3s_to_kmers <- function(cdr3s, k = K, cores = CORES) {
  cdr3s[nchar(cdr3s) >= k] %>%
    as.list() %>%
    mclapply(function(x) cdr3_to_kmers(x, k), 
             mc.set.seed = 42, 
             mc.cores = cores) %>%
    rbindlist
}
cdr3s_to_kmers(c("CASSLAPGATNEKLFF", "CGGGF", "CF", "CAAAAAAAAAAAF", "CGGGGGF"))
```